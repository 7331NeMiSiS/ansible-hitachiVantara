- name: Hitachi Vantara storage module example - UnPresent and Delete Lun
  hosts: caas
  gather_facts: yes
  vars:
  vars_files:
    - ./storage_registration.yml
  tasks:
    - name: Add Storage
      uri:
        url: "{{ vro_url_prefix }}/StorageManager/StorageManager/AddRAID"
        method: POST
        timeout: 120
        validate_certs: no
        return_content: yes
        body:
            sessionId: ""
            serialNumber: "{{ storage_serial|int }}"
            location: "{{ storage_IP }}"
            controllerIP: "{{ controller_IP }}"
            userID: "{{ user }}"
            password: "{{ password }}"
            gatewayServer: "{{ gatewayServer }}"
            gatewayServerPort: "{{ gatewayServerPort }}"
        body_format: json
      ignore_errors: yes
      register: add_storage

    - name: Print Add Storage JSON result
      debug: msg="{{ add_storage.json }}"

    - copy: content="{{ add_storage.json }}" dest=/root/jsons/add_storage.log

    - name: Unpresent Lun
      uri:
        url: "{{ vro_url_prefix }}/HostGroup/HostGroup/RemoveLogicalUnit"
        method: POST
        timeout: 120
        validate_certs: no
        return_content: yes
        body:
            sessionId: "{{ add_storage.json.SessionId }}"
            serialNumber: "{{ storage_serial|int }}"
            port: "{{ storage_port }}"
            hostGroupName: "{{ hostgroup_name }}"
            lun: "{{ lun_id }}"
        body_format: json
      ignore_errors: yes

    - name: Remove Storage
      uri:
        url: "{{ vro_url_prefix }}/StorageManager/StorageManager/CloseArrayConnections"
        method: POST
        timeout: 120
        validate_certs: no
        return_content: yes
        body:
            sessionId: "{{ add_storage.json.SessionId }}"
        body_format: json
      ignore_errors: yes

    # last task is deleting the LUN
    - name: Delete lun
      uri:
        url: "{{ url_prefix }}/storage/logical-units/{{ lun_id }}"
        method: DELETE
        timeout: 120
        headers:
          X-Subsystem-User: "{{ user }}"
          X-Subsystem-Password: "{{ password }}"
          X-Subsystem-Type: "{{ storage_type }}"
          X-Management-IPs: "{{ storage_IP }}"
          X-Storage-Id: "{{ storage_serial }}"
          Content-Type: "application/json"
        validate_certs: no
        return_content: yes
      ignore_errors: yes

    - name: Unpresenting and Deleting Lun
      debug: msg="Unpresenting and deleting Lun finished succesfully."
